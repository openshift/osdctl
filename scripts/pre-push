#!/bin/bash
set -e
echo "Running pre-push hook to check documentation"
DOCS_DIR_EXISTS=0
if [ -d "docs" ]; then
    DOCS_DIR_EXISTS=1
fi
FILE_EXISTS=0
if [ -f "osdctl_commands.md" ]; then
    FILE_EXISTS=1
    PRE_MD5=$(md5sum "osdctl_commands.md" | cut -d ' ' -f 1)
else
    PRE_MD5=""
fi
if [ $DOCS_DIR_EXISTS -eq 0 ] || [ $FILE_EXISTS -eq 0 ]; then
    echo "Missing documentation files. Running documentation generator..."
    
    if make generate-docs; then
        echo "Documentation files generated successfully."
        echo "Please add the new documentation files and push again:"
        echo "    git add docs/ osdctl_commands.md"
        echo "    git commit -m \"Add generated documentation\""
        exit 1
    else
        echo "Failed to generate documentation. Fix errors before pushing."
        exit 1
    fi
fi
if make generate-docs; then
    echo "Documentation checked successfully."
else
    echo "Failed to check documentation. Fix errors before pushing."
    exit 1
fi
if [ -f "osdctl_commands.md" ]; then
    POST_MD5=$(md5sum "osdctl_commands.md" | cut -d ' ' -f 1)
    
    if [ "$PRE_MD5" != "$POST_MD5" ]; then
        echo "ERROR: Documentation is out of date. The pre-push hook updated it."
        echo "Please add and commit the updated documentation before pushing:"
        echo "    git add docs/ osdctl_commands.md"
        echo "    git commit -m \"Update documentation\""
        exit 1
    else
        echo "Documentation is up to date."
    fi
else
    echo "ERROR: Documentation file osdctl_commands.md was not generated."
    exit 1
fi
echo "Pre-push hook completed successfully."
exit 0